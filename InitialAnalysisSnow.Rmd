---
title: "InitialAnalysisSnow"
author: "Shihong"
date: "Mar 21, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load packages
``` {r loadlibs, warning=FALSE, message=FALSE}
library(ggplot2)
library(cowplot)
library(lme4)
library(pbkrtest)
library(tidyr)
library(dplyr)
library(optimx)
library(broom)
```
### Stats
In this analyses, we would like to see survival, growth, diversity and abundance responding to snow removal treatment.


### 1.Data- survival
```{r dataorganisation}

## Read in data
snowdat <- read.csv("data/Snowwoodyseedlings_20170115.csv")

## reorder the factors in a sensible order
summary(snowdat)
snowdat$treatment <- factor(snowdat$treatment, levels=c('C', 'S'))
snowdat$growth.form <- factor(snowdat$growth.form, levels=c('tree', 'shrub'))

## there is occasionally trailing white space on some of the species names. 
## Removing this to prevent problems later.
snowdat$species <- factor(trimws(as.character(snowdat$species)))

## functions to add up number of seedlings in and number of deaths
totcalc <-  function(x) sum(!is.na(x) & x> 0)
deathcalc <- function(x) sum(!is.na(x) & x==0)

## remove code when summarise
snowdat.ag <- summarise(group_by(snowdat, site, quadrat, species, treatment, growth.form),
          total_15sp=totcalc(height_14fa),  total_15fa=totcalc(height_15sp), 
          deaths_15sp=deathcalc(height_15sp), deaths_15fa=deathcalc(height_15fa),
          total_16sp=totcalc(height_15fa),  total_16fa=totcalc(height_16sp), 
          deaths_16sp=deathcalc(height_16sp), deaths_16fa=deathcalc(height_16fa))

snowdat.ag <-  gather(snowdat.ag, "meas", "N", total_15sp:deaths_16fa) %>% 
  separate(meas, into=c("meas", "census"), sep="_") %>%
  spread(meas, N)
## calculate no. survivors as total - deaths
snowdat.ag$survs <- snowdat.ag$total - snowdat.ag$deaths

snowdat.ag <- subset(snowdat.ag, total > 0)

## get idea of representation of treatments
group_by(snowdat.ag, growth.form) %>% tally

snowdat.ag$quad.unique <- as.factor(paste(snowdat.ag$site,
                                          snowdat.ag$quadrat, sep='_'))

```


### 2. Surival- Initial plots
Now some initial plots

```{r initialplots}
ggplot(data=snowdat.ag,
       aes(x=treatment, y=survs/total)) + geom_violin()

ggplot(data=snowdat.ag, 
       aes(x=treatment, y=survs/total, colour=as.factor(census))) + 
  geom_boxplot() +
  facet_wrap(~growth.form)
summary(snowdat.ag)

group_by(snowdat.ag, treatment, growth.form, census) %>% 
  summarise(surv = mean(survs/total), 
            se.survs=sd(survs/total)/sqrt(length(survs/total))) %>% 
ggplot(aes(x=treatment, y=surv, ymin=surv-se.survs, ymax=surv+se.survs, 
           colour=as.factor(census))) + geom_errorbar() + geom_point() +
    facet_wrap(~growth.form) 

```
Maybe we can try to use 14fa, 15sp and 16sp data. It will be more interesting. For the experiment, we want to detect effects of snow removal on seedling performance. Thus, censuses after winter will be meaningful to access this effect. But including fall censuses also give some scenerios to see the time-lag effect.

Trees and shrubs respond differently to snow cover removal. Meanwhile, it seems to be a recovery ability for plants, easpecially for shrubs.


## 3. Survival- Initial models

First let us model survival as a function of treatments (snow removal and exclosure) and looking at growth forms separately. We had some issues with convergence using the default optimisers, so switched to those in the optimx package that worked better. Differences between fits were small, despite the convergence warnings. The plot level random effects had close to 0 variance and were therefore dropped from further analyses.
All analyses set W (water) as reference.

```{r survivalmodel}
snowdat.ag$site <- factor(snowdat.ag$site)
contrasts(snowdat.ag$site) <- "contr.sum"
summary(snowdat.ag)

#### tree
mod.snow.tree <- glmer(cbind(survs, deaths) ~ site + treatment*census +
                (1|quad.unique) + (1|species),
              data=subset(snowdat.ag, growth.form=='tree'), family=binomial, 
              control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))

mod.snow.tree1 <- glmer(cbind(survs, deaths) ~ site + treatment + census +
                (1|quad.unique) + (1|species),
              data=subset(snowdat.ag, growth.form=='tree'), family=binomial, 
              control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))
anova(mod.snow.tree, mod.snow.tree1)

mod.snow.tree.diags <- augment(mod.snow.tree)
qplot(data=mod.snow.tree.diags, x=.fitted, y=.resid, geom=c('point', 'smooth')) +
  geom_hline(yintercept=0, linetype='dotted')
qplot(data = mod.snow.tree.diags, x= treatment, y=.wtres, geom="boxplot", colour=census) 

## plot fixed and random effects
library(sjPlot)
sjp.lmer(mod.snow.tree, type='fe', p.kr = FALSE)
sjp.lmer(mod.snow.tree, type='re', sort.est="sort.all", p.kr = FALSE)
## random effects of quadrat is doggy
summary(mod.snow.tree, correlation=FALSE)
summary(mod.snow.tree1, correlation=FALSE)

#### shrub
mod.snow.shrub <- glmer(cbind(survs, deaths) ~ site + treatment*census +
                (1|quad.unique) + (1|species),
              data=subset(snowdat.ag, growth.form=='shrub'), family=binomial, 
              control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))

mod.snow.shrub1 <- glmer(cbind(survs, deaths) ~ site + treatment + census +
                (1|quad.unique) + (1|species),
              data=subset(snowdat.ag, growth.form=='shrub'), family=binomial, 
              control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))

mod.snow.shrub.diags <- augment(mod.snow.shrub)
qplot(data=mod.snow.shrub.diags, x=.fitted, y=.resid, geom=c('point', 'smooth')) +
  geom_hline(yintercept=0, linetype='dotted')
qplot(data = mod.snow.shrub.diags, x= treatment, y=.wtres, geom="boxplot", colour=census) 

## plot fixed and random effects
sjp.lmer(mod.snow.shrub, type='fe', p.kr = FALSE)
sjp.lmer(mod.snow.shrub, type='re', sort.est="sort.all", p.kr = FALSE)

summary(mod.snow.shrub, correlation=FALSE)
summary(mod.snow.shrub1, correlation=FALSE)

```

### 4. Survival- specific group or invidual species
First, we would like to see snow cover effects on two dominant species. Then, analysis would be conducted on rest of species other than those two dominant species. Last, common species were checked one by one. 17 species fulfilled our criteria, but only five (or six) species fitted well in glmm modles. 
```{r indivspeciesmodel}
## Fraxinus mandschurica
mod.snow.Fmand <- glmer(cbind(survs, deaths) ~ site + treatment*census +
                (1|quad.unique),
              data=snowdat.ag[snowdat.ag$species == 'Fraxinus mandschurica',],family=binomial,
              control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))

mod.snow.Fmand1 <- glmer(cbind(survs, deaths) ~ site + treatment + census +
                (1|quad.unique),
              data=snowdat.ag[snowdat.ag$species == 'Fraxinus mandschurica',],family=binomial,
              control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))

mod.snow.Fmand.diags <- augment(mod.snow.Fmand)
qplot(data=mod.snow.Fmand.diags, x=.fitted, y=.resid, geom=c('point', 'smooth')) +
  geom_hline(yintercept=0, linetype='dotted')
qplot(data = mod.snow.Fmand.diags, x= treatment, y=.wtres, geom="boxplot", colour=census) 

## plot fixed and random effects
sjp.lmer(mod.snow.Fmand, type='fe', p.kr = FALSE)
sjp.lmer(mod.snow.Fmand, type='re', sort.est="sort.all", p.kr = FALSE)

summary(mod.snow.Fmand, correlation=FALSE)
summary(mod.snow.Fmand1, correlation=FALSE)

## Tilia amurensis
mod.snow.Tamur <- glmer(cbind(survs, deaths) ~ site + treatment*census +
                (1|quad.unique),
              data=snowdat.ag[snowdat.ag$species == 'Tilia amurensis',], family=binomial, 
              control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))

mod.snow.Tamur1 <- glmer(cbind(survs, deaths) ~ site + treatment + census +
                (1|quad.unique),
              data=snowdat.ag[snowdat.ag$species == 'Tilia amurensis',], family=binomial, 
              control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))

mod.snow.Tamur.diags <- augment(mod.snow.Tamur)
qplot(data=mod.snow.Tamur.diags, x=.fitted, y=.resid, geom=c('point', 'smooth')) +
  geom_hline(yintercept=0, linetype='dotted')
qplot(data = mod.snow.Tamur.diags, x= treatment, y=.wtres, geom="boxplot", colour=census) 

## plot fixed and random effects
sjp.lmer(mod.snow.Tamur, type='fe', p.kr = FALSE)
sjp.lmer(mod.snow.Tamur, type='re', sort.est="sort.all", p.kr = FALSE)

summary(mod.snow.Tamur, correlation=FALSE)
summary(mod.snow.Tamur1, correlation=FALSE)

## other species
mod.snow.other <- glmer(cbind(survs, deaths) ~ site + treatment*census +
                (1|quad.unique) + (1|species),
              data=subset(snowdat.ag, species != 'Fraxinus mandschurica' & species != 'Tilia amurensis'), family=binomial, 
              control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))

mod.snow.other1 <- glmer(cbind(survs, deaths) ~ site + treatment + census +
                (1|quad.unique) + (1|species),
              data=subset(snowdat.ag, species != 'Fraxinus mandschurica' & species != 'Tilia amurensis'), family=binomial, 
              control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))

mod.snow.other.diags <- augment(mod.snow.other)
qplot(data=mod.snow.other.diags, x=.fitted, y=.resid, geom=c('point', 'smooth')) +
  geom_hline(yintercept=0, linetype='dotted')
qplot(data = mod.snow.other.diags, x= treatment, y=.wtres, geom="boxplot", colour=census) 

## plot fixed and random effects
sjp.lmer(mod.snow.other, type='fe', p.kr = FALSE)
sjp.lmer(mod.snow.other, type='re', sort.est="sort.all", p.kr = FALSE)

summary(mod.snow.other, correlation=FALSE)
summary(mod.snow.other1, correlation=FALSE)


#####################
## individual species
#####################
sampsize.snow <- as.data.frame(table(snowdat.ag$species, snowdat.ag$treatment))
colnames(sampsize.snow) <- c('species', 'treatment','no.quad')
sampsize.snow <- sampsize.snow %>% 
  spread(treatment, no.quad)

sel.sp.snow <- unique(sampsize.snow$species[sampsize.snow$C >= 3 & sampsize.snow$S >= 3])
## only one site
sel.sp.snow.leave <- sel.sp.snow[-c(5,12)]

## model
indivmods.snow <- sapply(sel.sp.snow.leave, function(sp){
  print(sp)
    spdat <- filter(snowdat.ag, species == sp)
  spdat <- droplevels(spdat)
  mod <- glmer(cbind(survs, deaths) ~ site + treatment + census + (1|quad.unique),
               data=spdat, family=binomial, 
               control=glmerControl(optimizer="optimx",
                                    optCtrl=list(method=c('bobyqa', 'Nelder-Mead')))
  )
}, simplify=FALSE)

library(lattice)
lapply(indivmods.snow, function(mod){
  dotplot(ranef(mod, condVar=TRUE))})

lapply(indivmods.snow, function(x) summary(x, correlation=FALSE))
lapply(indivmods.snow, function(x) anova(x))

```

### 5. Growth- Data manipulation
```{r growthdata}
g.snowdat <- snowdat[-c(12:16,19)]

## First census
for (i in 1:dim(g.snowdat)[1]) {
  if (any(g.snowdat$height_14fa[i] !=0 & !is.na(g.snowdat$height_14fa[i]) & 
          g.snowdat$height_15sp[i] !=0 & !is.na(g.snowdat$height_15sp[i]))) {
    g.snowdat$g_15sp[i] <- g.snowdat$height_15sp[i] - g.snowdat$height_14fa[i] 
  } else {g.snowdat$g_15sp[i] <- NA}
}

## Second census
for (i in 1:dim(g.snowdat)[1]) {
  if (any(g.snowdat$height_15sp[i] !=0 & !is.na(g.snowdat$height_15sp[i]) &
          g.snowdat$height_15fa[i] !=0 & !is.na(g.snowdat$height_15fa[i]))) {
    g.snowdat$g_15fa[i] <- g.snowdat$height_15fa[i] - g.snowdat$height_15sp[i] 
  } else {g.snowdat$g_15fa[i] <- NA}
}

## Third census
for (i in 1:dim(g.snowdat)[1]) {
  if (any(g.snowdat$height_15fa[i] !=0 & !is.na(g.snowdat$height_15fa[i]) &
          g.snowdat$height_16sp[i] !=0 & !is.na(g.snowdat$height_16sp[i]))) {
    g.snowdat$g_16sp[i] <- g.snowdat$height_16sp[i] - g.snowdat$height_15fa[i] 
  } else {g.snowdat$g_16sp[i] <- NA}
}

## Forth census
for (i in 1:dim(g.snowdat)[1]) {
  if (any(g.snowdat$height_16sp[i] !=0 & !is.na(g.snowdat$height_16sp[i]) &
          g.snowdat$height_16fa[i] !=0 & !is.na(g.snowdat$height_16fa[i]))) {
    g.snowdat$g_16fa[i] <- g.snowdat$height_16fa[i] - g.snowdat$height_16sp[i] 
  } else {g.snowdat$g_16fa[i] <- NA}
}

g.snowdat.ag1 <- gather(g.snowdat, gg, grow, g_15sp:g_16fa) %>%  
  separate(gg, c("item","census"))
names(g.snowdat.ag1)
g.snowdat.ag <- g.snowdat.ag1[,-c(7:11,14)]

g.snowdat.ag <- subset(g.snowdat.ag,!is.na(g.snowdat.ag$grow))

## get idea of representation of treatments
group_by(g.snowdat.ag, growth.form) %>% tally

g.snowdat.ag$quad.unique <- as.factor(paste(g.snowdat.ag$site, 
                                            g.snowdat.ag$quadrat, sep='_'))

```
### 3. Growth- Initial plots
Now some initial plots

```{r initialplotsgrowth}
ggplot(data=g.snowdat.ag,
       aes(x=treatment, y=grow)) + geom_violin() +
  geom_hline(aes(yintercept=0),linetype="dashed")

ggplot(data=g.snowdat.ag,
       aes(x=treatment, y=grow, colour=as.factor(site))) + geom_violin() +
  geom_hline(aes(yintercept=0),linetype="dashed")

ggplot(data=g.snowdat.ag,
       aes(x=treatment, y=grow, colour=as.factor(census))) + geom_violin() +
  geom_hline(aes(yintercept=0),linetype="dashed")

group_by(g.snowdat.ag, treatment, growth.form, census) %>% 
  summarise(mean.grow = mean(grow), 
            se.grow=sd(grow)/sqrt(length(grow))) %>% 
ggplot(aes(x=treatment, y=mean.grow, ymin=mean.grow-se.grow, ymax=mean.grow+se.grow, 
           colour=as.factor(census))) + geom_errorbar() + geom_point() +
    facet_wrap(~growth.form) +
  geom_hline(aes(yintercept=0),linetype="dashed")

```

### Growth- Initial Models
```{r initialmodelsgrowth}
g.snowdat.ag$site <- factor(g.snowdat.ag$site)
contrasts(g.snowdat.ag$site) <- "contr.sum"

#### tree growth
mod.s.tree.grow <- lmer(grow ~ site + treatment*census + 
                   (1|quad.unique) + (1|species), 
                  data=subset(g.snowdat.ag, growth.form=='tree'))

mod.s.tree.grow.diags <- augment(mod.s.tree.grow)
qplot(data=mod.s.tree.grow.diags, x=.fitted, y=.resid, geom=c('point', 'smooth')) +
  geom_hline(yintercept=0, linetype='dotted')
qplot(data = mod.s.tree.grow.diags, x= treatment, y=.wtres, geom="boxplot",colour=census) +
  geom_hline(yintercept=0, linetype='dotted')
summary(mod.s.tree.grow, correlation=FALSE)

#### shrub growth
mod.s.shrub.grow <- lmer(grow ~ site + treatment*census + 
                   (1|quad.unique) + (1|species), 
                  data=subset(g.snowdat.ag, growth.form=='shrub'))

mod.s.shrub.grow.diags <- augment(mod.s.shrub.grow)
qplot(data=mod.s.shrub.grow.diags, x=.fitted, y=.resid, geom=c('point', 'smooth')) +
  geom_hline(yintercept=0, linetype='dotted')
qplot(data = mod.s.shrub.grow.diags, x= treatment, y=.wtres, geom="boxplot",colour=census) +
  geom_hline(yintercept=0, linetype='dotted')
summary(mod.s.shrub.grow, correlation=FALSE)

## remove outliers
library(LMERConvenienceFunctions)

g.snowdat.ag.shrub.reout <- romr.fnc(mod.s.shrub.grow, subset(g.snowdat.ag, growth.form=='shrub'), trim = 2.5 )
g.snowdat.ag.shrub.reout <- g.snowdat.ag.shrub.reout$data

## update model
mod.s.shrub.grow.reout <- lmer(grow ~ site + treatment*census + 
                   (1|quad.unique) + (1|species), 
                  data=g.snowdat.ag.shrub.reout)

mod.s.shrub.grow.reout.diags <- augment(mod.s.shrub.grow.reout)
qplot(data=mod.s.shrub.grow.reout.diags, x=.fitted, y=.resid, geom=c('point', 'smooth')) +
  geom_hline(yintercept=0, linetype='dotted')
qplot(data = mod.s.shrub.grow.reout.diags, x= treatment, y=.wtres, geom="boxplot",colour=census) +
  geom_hline(yintercept=0, linetype='dotted')
summary(mod.s.shrub.grow.reout, correlation=FALSE)

```

Snow removal treatment suppressed seedling survival but not growth. It affected survival of both trees and shrubs. It do not influence those two most dominant species (*Fraxinus mandschurica* and *Tilia amurensis*). There are still some problems with the models when trying to access individual species for survival.


### Analysis of diversity
First need to calculate the diversity in each quadrat. Here, I use density of survivors instead of total density, because total sensity includes both survivors and deaths.

```{r diversitycalcsnow}
library(vegan)
sp.diversity_woodsnow <- summarise(
  group_by(snowdat.ag, site, quadrat, quad.unique, treatment, census), 
  shannon=diversity(survs), simpson=diversity(survs, index='invsimpson'))
sp.diversity_woodsnow

ggplot(sp.diversity_woodsnow, aes(x=treatment, y=shannon, colour = census)) +  geom_boxplot()
summarise(group_by(sp.diversity_woodsnow, treatment, site, census), meanH=mean(shannon), 
          seH=sd(shannon)/sqrt(length(shannon))) %>%
  ggplot(aes(x=treatment, y=meanH, ymin=meanH-seH, ymax=meanH+seH, colour=census, 
             shape=site)) + geom_pointrange() + coord_trans(y="exp") +
  labs(x="pesticide", y="Effective number of species")

sp.diversity_woodsnow$census <- factor(sp.diversity_woodsnow$census, levels=c('15sp', '15fa','16sp', '16fa'))
mod.woodsnow.div <- lmer(shannon ~ site + census*treatment + (1|quad.unique), data=sp.diversity_woodsnow)

plot(mod.woodsnow.div, type=c('p', 'smooth'))

library(sjPlot)
sjp.lmer(mod.woodsnow.div, type='fe')
sjp.lmer(mod.woodsnow.div, type='re', sort.est="sort.all" )

summary(mod.woodsnow.div, correlation=FALSE)

```
Snow removal decreased plant diversity.

### Abundance analysis (woody seedlings- snow)
```{r abundancecalc.woodsnow}
snow.abundat <- aggregate(survs ~ treatment + site + quadrat + quad.unique + census, data=snowdat.ag, FUN=sum)
names(snow.abundat)[names(snow.abundat) == 'survs'] <- 'abundance'
snow.abundat$census <- factor(snow.abundat$census, levels=c('15sp', '15fa','16sp', '16fa'))

## interaction not significant, thus remove it
## variance of plots is zero, so drop it.
mod.woodsnow.abun <- glmer(abundance ~ site + census + treatment +(1|quad.unique),
                        data=snow.abundat, family=poisson, 
                        control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))

mod.woodsnow.abun.diags <- augment(mod.woodsnow.abun)
qplot(data=mod.woodsnow.abun.diags, x=.fitted, y=.resid, geom=c('point', 'smooth')) +
  geom_hline(yintercept=0, linetype='dotted')
qplot(data = mod.woodsnow.abun.diags, x= treatment, y=.wtres, geom="boxplot", colour=census) 

sjp.lmer(mod.woodsnow.abun, type='fe')
sjp.lmer(mod.woodsnow.abun, type='re', sort.est="sort.all" )
summary(mod.woodsnow.abun, correlation=FALSE)

### Individual species analysis
## sample size data frame
sampsize.snowind <- as.data.frame(table(snowdat.ag$species, snowdat.ag$treatment, snowdat.ag$site, snowdat.ag$census))
colnames(sampsize.snowind) <- c('species', 'treatment', 'site', 'census', 'no.quad')

sampsize.snowind <- sampsize.snowind %>% 
  spread(treatment, no.quad) 

sel.sp.woodsnow <- unique(sampsize.snowind$species[sampsize.snowind$C >= 3 & 
                        sampsize.snowind$S >= 3])

## previous tests showed all these species fullfil the criteria of including all the variables. Also, plot variances were rare, so drop this in the random effects.
indivmods.woodsnow <- sapply(sel.sp.woodsnow, function(sp){
  print(sp)
  spdat <- filter(snowdat.ag, species == sp)
  spdat <- droplevels(spdat)
  if (length(unique(spdat$site)) >= 2 & length(unique(spdat$census)) >= 2){
    mod <- glmer(survs ~ site + census*treatment + (1|quad.unique),
                 data=spdat, family=poisson,
                 control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))
  } else if (length(unique(spdat$site)) < 2 & length(unique(spdat$census)) >= 2){
    mod <- glmer(survs ~ census*treatment + (1|quad.unique),
                 data=spdat, family=poisson,
                 control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))
  } else {
    mod <- glmer(survs ~ treatment + (1|quad.unique),
                 data=spdat, family=poisson,
                 control=glmerControl(optimizer="optimx", 
                                   optCtrl=list(method=c('bobyqa', 'Nelder-Mead'))))
  }
  
}, simplify=FALSE)

### plot residuals
lapply(indivmods.woodsnow, function(mod){
  plot(mod, type=c('p', 'smooth'))})
lapply(indivmods.woodsnow, function(mod){
  dotplot(ranef(mod, condVar=TRUE))})

lapply(indivmods.woodpest, function(x) summary(x, correlation=FALSE))

```
Snow removal suppressed plant abundance.



